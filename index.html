<!DOCTYPE html>
<html>
<head>
    <title>P2P Chess</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
        }
        #board {
            display: grid;
            grid-template-columns: repeat(8, 60px);
            gap: 0;
            border: 2px solid #333;
            margin: 20px;
        }
        .square {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            cursor: pointer;
        }
        .white { background-color: #f0d9b5; }
        .black { background-color: #b58863; }
        .selected { background-color: #7fff00; }
        #status { margin: 10px; font-weight: bold; }
        #connect { margin: 10px; padding: 5px; }
    </style>
</head>
<body>
    <div id="status">Disconnected</div>
    <div id="board"></div>
    <input id="connect" type="text" placeholder="Enter server URL (ws://...)">
    <button onclick="connect()">Connect</button>

<script>
const pieces = {
    'R': '♜', 'N': '♞', 'B': '♝', 'Q': '♛', 'K': '♚', 'P': '♟',
    'r': '♖', 'n': '♘', 'b': '♗', 'q': '♕', 'k': '♔', 'p': '♙'
};

let ws, isWhite, currentTurn = 'white', selectedSquare = null;
const board = Array(64).fill(null);

function createBoard() {
    const container = document.getElementById('board');
    container.innerHTML = '';
    
    // Initial board setup
    const initial = [
        'R','N','B','Q','K','B','N','R',
        'P','P','P','P','P','P','P','P',
        ...Array(32).fill(null),
        'p','p','p','p','p','p','p','p',
        'r','n','b','q','k','b','n','r'
    ];

    initial.forEach((piece, index) => {
        const square = document.createElement('div');
        square.className = `square ${(Math.floor(index/8) + index%8) % 2 ? 'white' : 'black'}`;
        square.dataset.index = index;
        square.textContent = pieces[piece] || '';
        square.onclick = () => handleSquareClick(index);
        container.appendChild(square);
        board[index] = piece;
    });
}

function handleSquareClick(index) {
    if (!isWhite || currentTurn !== (isWhite ? 'white' : 'black')) return;
    
    if (selectedSquare === null) {
        if (board[index] && (isWhite === (board[index] === board[index].toUpperCase()))) {
            selectedSquare = index;
            document.querySelectorAll('.square')[index].classList.add('selected');
        }
    } else {
        const from = selectedSquare;
        const to = index;
        movePiece(from, to);
        selectedSquare = null;
        document.querySelectorAll('.square').forEach(sq => sq.classList.remove('selected'));
    }
}

function movePiece(from, to) {
    if (!isValidMove(from, to)) return;
    
    board[to] = board[from];
    board[from] = null;
    updateBoard();
    currentTurn = currentTurn === 'white' ? 'black' : 'white';
    
    if (ws) {
        ws.send(JSON.stringify({ type: 'move', from, to }));
    }
}

function isValidMove(from, to) {
    // Basic move validation (simplified)
    const piece = board[from];
    if (!piece) return false;
    if (piece === piece.toLowerCase() && currentTurn === 'white') return false;
    if (piece === piece.toUpperCase() && currentTurn === 'black') return false;
    return true;
}

function updateBoard() {
    document.querySelectorAll('.square').forEach((square, index) => {
        square.textContent = pieces[board[index]] || '';
    });
}

function connect() {
    const serverUrl = document.getElementById('connect').value;
    ws = new WebSocket(serverUrl);

    ws.onopen = () => {
        document.getElementById('status').textContent = 'Connected! Waiting for opponent...';
        ws.send(JSON.stringify({ type: 'join' }));
    };

    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        switch(msg.type) {
            case 'color':
                isWhite = msg.color === 'white';
                document.getElementById('status').textContent = `You play ${msg.color}`;
                break;
            case 'move':
                board[msg.to] = board[msg.from];
                board[msg.from] = null;
                currentTurn = msg.newTurn;
                updateBoard();
                break;
            case 'start':
                currentTurn = 'white';
                break;
        }
    };

    ws.onclose = () => {
        document.getElementById('status').textContent = 'Connection lost';
    };
}

// Initialize board
createBoard();
</script>
</body>
</html>