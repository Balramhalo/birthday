const express = require('express');
const fs = require('fs').promises;
const path = require('path');
const app = express();
const port = process.env.PORT || 3000;

app.use(express.json());
app.use(express.static('public'));

// Balram Alphabet
const alphabet = [
    { char: 'Al', pronunciation: 'ahl' },
    { char: 'Ba', pronunciation: 'bah' },
    { char: 'Ga', pronunciation: 'gah' },
    { char: 'Ma', pronunciation: 'mah' },
    { char: 'Ra', pronunciation: 'rah' }
];

// Load or initialize vocabulary
const vocabFile = path.join(__dirname, 'data', 'vocabulary.json');
async function loadVocabulary() {
    try {
        const data = await fs.readFile(vocabFile, 'utf8');
        return JSON.parse(data);
    } catch (error) {
        return { alphabet, words: [] };
    }
}

async function saveVocabulary(data) {
    await fs.writeFile(vocabFile, JSON.stringify(data, null, 2));
}

// Self-generating word algorithm
function generateWord(phrase) {
    const vowels = ['a', 'e', 'i', 'o', 'u'];
    let word = '';
    const words = phrase.toLowerCase().split(' ');
    for (let w of words) {
        let newWord = '';
        for (let i = 0; i < w.length; i += 2) {
            const randChar = alphabet[Math.floor(Math.random() * alphabet.length)].char;
            newWord += randChar + (vowels.includes(w[i]) ? 'm' : 'l');
        }
        word += newWord + ' ';
    }
    return word.trim();
}

// Emoji mapping
const emojiMap = {
    happy: 'ðŸ˜Š',
    sad: 'ðŸ˜¢',
    love: 'â¤ï¸',
    default: 'âœ¨'
};

app.post('/translate', async (req, res) => {
    const { phrase } = req.body;
    const vocab = await loadVocabulary();
    const translation = generateWord(phrase);
    const emoji = emojiMap[phrase.toLowerCase()] || emojiMap.default;
    const breakdown = `Generated from "${phrase}" using Balram alphabet`;

    vocab.words.push({ word: translation, meaning: phrase, emoji });
    await saveVocabulary(vocab);

    res.json({ translation, breakdown, emoji });
});

app.get('/vocabulary', async (req, res) => {
    const vocab = await loadVocabulary();
    res.json(vocab);
});

app.listen(port, () => console.log(`Server running on port ${port}`));